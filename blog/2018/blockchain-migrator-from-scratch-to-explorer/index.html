<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p>I came to know about the<a href="https://www.youtube.com/watch?v=bBC-nXj3Ng4" rel="external nofollow noopener" target="_blank"> <strong>Bitcoin</strong></a> when it’s price skyrocketed in 2017. The crypto-currencies have always been a topic of speculation. It is decentralising the financial system and transferring the control from governments and banks to people themselves.</p> <p>This article will guide you from understanding the bitcoin Node to extracting information from it. The explorer is based on Django with database in Postgre Sql. So, here we go.</p> <h3>Bitcoin Node — What is it ?</h3> <p>Bitcoin is a decentralised network (P2P network protocol), similar to torrents but in regard to currency with no central authority. Any computer that is connected to the Bitcoin network is a <strong>Bitcoin Node. </strong>To<strong> </strong>work upon bitcoin you need to set up the node on your computer, you may or may not download the full node to work upon. The steps in this link will help you setup the bitcoin-core in your system.</p> <blockquote><a href="https://www.linuxbabe.com/ubuntu/install-bitcoin-core-wallet-ubuntu-16-04-16-10" rel="external nofollow noopener" target="_blank">https://www.linuxbabe.com/ubuntu/install-bitcoin-core-wallet-ubuntu-16-04-16-10</a></blockquote> <p>So, now you are done installing the bitcoind or bitcoin-qt according to your preference. Run it and it will download the .blk and .lbd files to your root folder in blocks directory. <br>Well wait, what are <strong>.blk and .lbd files ?</strong></p> <p><strong><em>BLK </em></strong><em>files</em><strong><em> </em></strong><em>are used for controlling the data that is published to a shareable file. In reference to bitcoin, Every block that your node receives gets appended to a blk.dat file. Also, instead of the entire block chain being stored in one massive file, they are split in to multiple blk*.dat files.</em></p> <p><em>An</em><strong><em> LDB </em></strong><em>file is a lock information file that prevents any Access database from being changed by more than one user at a time. In reference to bitcoin they lock the folder to establish an uninterrupted connection. To use the data, you should download the full node or stop the node syncing process.</em></p> <p>These files have different encoding to store a large amount of information, so special parser have to be used to convert the hex into usable format. The parser will pick up the blk files in ordered fashion to calculate the height of the blocks as well.</p> <figure><img alt="" src="https://cdn-images-1.medium.com/max/531/1*DxNWxQBjo-kxxlfJ84oIlQ.png"><figcaption>Block Structure in Bitcoin.</figcaption></figure> <p>The above picture depicts the block structure of block chain. Each block is connected to each other by a previous block hash(connecting it in inverse order). A block hash includes transactions which in turn are performed between addresses.</p> <p>Currently the maximum size of a single bitcoin block is 1mb; which is only big enough to support approximately 7 transactions per second, which quite frankly is rather disappointing. At a future time the block size may be increased but, if that were to occur, the already massive block chain would blow up out of control. This is a major issue for the bitcoin protocol. It cannot in any way support a massive number of transactions which could accommodate global commerce traffic, as of yet.</p> <h3>Migrating into database — From .blk to postgres through django.</h3> <h4>Bitcoin Parser — From Node to usable data</h4> <p>A Block Parser reads the Bitcoin’s blocks. The blockchain is a decentralised database. Bitcoin is a pseudonymous system. Meaning, ECDSA key pairs are used to abstract the identity of users. There is encrypted and public data stored on the blockchain. Public data can be accessed by nodes to view the state of transactions. Encrypted data is used to create such transactions. All of the binary data in the blockchain can be read.</p> <p>The Bitcoin protocol dictates its structure and is the means through which each node maintains a duplicate copy. Overall, the block chain is just a data structure for storing blocks. The blockchain stores blocks in a series, beginning with the genesis block.</p> <p>Parsing the blk files requires ‘parsing libraries’ such as: binascii, double_sha_256, hashlib.</p> <ul><li><strong>Block Details</strong></li></ul> <ol> <li>Block Header — The first 4 bytes of a block in the block chain file is a 32 bit header referred to as a ‘magic id’. This is simply an identifier to let us know that we are at the beginning of a block.</li> <li>Block Length — The next 4 bytes of the block header contain the length of this block.</li> <li>Previous Block Hash — This entry contains a 32 byte hash of the ‘previous’ block. Think of this like a linked list. Each block in the block chain points to a previous block, except the genesis block.</li> <li>Merkle Root — This 32 byte hash is not needed to parse the bitcoin transactions. It is required for rapid access of bitcoin data history by bitcoin core.</li> <li>Difficulty — A measure of how difficult it is to find a hash below a given target.</li> <li>Nonce — This value is a random number value used as part of the mining process.</li> </ol> <ul><li><strong>Transaction Details</strong></li></ul> <ol> <li>Version — It’s start with the transaction’s version number(expected to be 0 or 1).</li> <li>Transaction Number — This part depicts the number of transactions contained in this transaction.</li> <li>Transaction Hash — These 32 bytes represent a hash of some previous transaction in the block chain. It is very important to note, this transaction hash is stored nowhere in the block chain itself!! It is a computed value.</li> <li>Transaction Index — This value says which output of that transaction comprises this input.</li> <li>Script Length — It shows the length of the input script.</li> <li>Script Data — This raw data comprises of input-script. The input-script combined with the output script, which we will cover in a moment, are used by the bitcoin system to validate transactions.</li> <li>Sequence Number — A number intended to allow <a href="https://bitcoin.org/en/glossary/confirmation-score" rel="external nofollow noopener" target="_blank">unconfirmed</a> time-locked transactions to be updated before being finalised; not currently used except to disable <a href="https://bitcoin.org/en/glossary/locktime" rel="external nofollow noopener" target="_blank">lock time</a> in a transaction.</li> <li>Output Number — It shows the number of outputs involved in the transaction.</li> <li>Output Value — Value is the number of Satoshi (1 BTC = 100,000,000 Satoshi) that this output will be worth when claimed.</li> <li>Output Script Length — It shows the length of the output script.</li> <li>Output Script — Even though we don’t have to execute the script to validate it, we do need to inspect the script to figure out where the output goes.</li> </ol> <h4>The SQL database</h4> <p><em>Firstly, why to use RDBMS?<br></em>Traditionally, relational databases are considered better for atomic transactions. In financial sectors, the relational databases are preferred because of tables’ closely inter-bound nature using foreign keys and indexes. They are used to uniquely identify any atomic piece of data within the table. Bitcoin hashes and stores the data such that every hash is unique to the transaction or the block. These hashes can be used to identify particular transactions or blocks and hence can be used as a primary key.</p> <p><em>Finally, why to use Postgres?</em><br>Compared to other RDBMSs, <strong>PostgreSQL</strong> differs itself with its support for highly required and integral object-oriented and/or relational database functionality, such as the complete support for reliable transactions, i.e. Atomicity, Consistency, Isolation, Durability (ACID).</p> <ul><li><strong>Data integrity:</strong></li></ul> <p>When reliability and data integrity are an absolute necessity without excuses, PostgreSQL is the better choice.</p> <ul><li><strong>Complex, custom procedures:</strong></li></ul> <p>If you require your database to perform custom procedures, PostgreSQL, being extensible, is the better choice.</p> <ul><li><strong>Integration:</strong></li></ul> <p>In the future, if there is a chance of necessity arising for migrating the entire database system to a propriety (e.g. Oracle) solution, PostgreSQL will be the most compliant and easy to handle base for the switch.</p> <ul><li><strong>Complex designs:</strong></li></ul> <p>Compared to other open-source and free RDBMS implementations, for complex database designs, PostgreSQL offers the most in terms of functionality and possibilities without giving up on other valuable assets.</p> <ul><li>Setting up the Database, Postgres is easy to setup, Follow the link below for the steps to setup Postgres in ubuntu.</li></ul> <blockquote><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-16-04" rel="external nofollow noopener" target="_blank"><em>https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-16-04</em></a></blockquote> <p>After you are done installing postgres, type in the following commands to setup a database and become a user granting all privileges.</p> <pre>$ sudo -u postgres psql</pre> <p>This will open the command line for postgres, then <strong>create user, database granting all privileges :</strong></p> <pre>CREATE DATABASE yourdbname;<br>CREATE USER youruser WITH ENCRYPTED PASSWORD 'yourpass';<br>GRANT ALL PRIVILEGES ON DATABASE yourdbname TO youruser;</pre> <p><strong>The Server:</strong></p> <p>Django, a web application based framework of python, lets the developer create API calls and database structure like a breeze.<br>It follows the MVT (Model-View-Template) architectural pattern and is maintained by the Django Software Foundation, an independent organisation established as a 501 non-profit.</p> <p>Why to use Django:</p> <ul> <li> <strong>Fast.<br></strong>Django was designed to help developers take applications from concept to completion as quickly as possible.</li> <li> <strong>Reassuringly secure.</strong><br>Django takes security seriously and helps developers avoid many common security mistakes.</li> <li> <strong>Exceedingly scalable.</strong><br>Some of the busiest sites on the Web leverage Django’s ability to quickly and flexibly scale.</li> </ul> <p>Now, let’s setup the Django server : <br>Prerequisites : <br>1. Python (2.7 or above and path added to the environment variable)<br>2. pip<br>Go to your terminal:</p> <pre>pip install django</pre> <p>Now, to setup a project in django, type in the following commands:</p> <pre>$ django-admin startproject "your_project_name"<br>  cd into the project directory<br>$ django-admin startapp "your_app_name"</pre> <p>And yes, that’s pretty much it.<br>To learn the MVT structure, you should pick up this <a href="https://docs.djangoproject.com/en/2.0/intro/tutorial01/" rel="external nofollow noopener" target="_blank">official tutorial</a> from django developers. This will give you a deep insight about web app developement.</p> <p><strong>Getting back to bitcoin</strong> — We need to design a database structure to store it in a way that it’s optimised and easily usable.</p> <p>So, we need to design tables namely, Block, Transactions, Output Addresses, Input Addresses. As the data contain multi-million entries, to make the read query efficient the relations in the tables are indexed. The indexing algorithm works on the B-tree structure.</p> <figure><img alt="" src="https://cdn-images-1.medium.com/max/313/1*Pb6WRnaB7okekVrZx4hVsg.png"><figcaption>Block Table</figcaption></figure> <figure><img alt="" src="https://cdn-images-1.medium.com/max/287/1*5hVt0wPdJ8pJisWF2Lqvag.png"><figcaption>Transaction Table</figcaption></figure> <p><em>The Input and Output addresses table contains Transaction hash as the foreign key of the transaction table.</em></p> <figure><img alt="" src="https://cdn-images-1.medium.com/max/320/1*iP_j89fksDB0gFSLPRcXXw.png"><figcaption>Input Table</figcaption></figure> <figure><img alt="" src="https://cdn-images-1.medium.com/max/312/1*BJ8rnGo0w3nPf21qo3lnmw.png"><figcaption>Output Table</figcaption></figure> <p>To view the data in a more organised and refined fashion, we created web page views with Django -templates.</p> <figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*Y88Bbg-owIgDeB-TPKRAdg.png"></figure> <figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*nSd2cpEtVFTNVDv0OYLHZw.png"></figure> <p><em>Transaction table is linked to the block table by one to one mapping through the block height relation.</em></p> <figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*V4DSwYiLn5dYKOtHESKcvQ.png"></figure> <p><em>Address details also include the transactions included through those addresses along with their details. The address tables are mapped to transaction tables by making the transaction hash a foreign key in each case.</em></p> <h3><strong>Conclusion :</strong></h3> <p>I hope this gives you an insight about the bitcoin and the explorers that work on it. The challenges Ifaced regarding the parsing and migration, I have thoroughly tried to explain them. Let me know if you have any other doubts at info@blockwala.io .</p> <p>You can check our working explorer on this link :<br><a href="http://explorer.blockwala.io/btc/index/" rel="external nofollow noopener" target="_blank"><strong><em>http://explorer.blockwala.io/btc/index/</em></strong></a></p> <h3>References :</h3> <ol> <li><a href="https://www.digitalocean.com/community/tutorials/sqlite-vs-mysql-vs-postgresql-a-comparison-of-relational-database-management-systems" rel="external nofollow noopener" target="_blank">https://www.digitalocean.com/community/tutorials/sqlite-vs-mysql-vs-postgresql-a-comparison-of-relational-database-management-systems</a></li> <li><a href="http://codesuppository.blogspot.com/2014/01/how-to-parse-bitcoin-blockchain.html" rel="external nofollow noopener" target="_blank">http://codesuppository.blogspot.com/2014/01/how-to-parse-bitcoin-blockchain.html</a></li> </ol> <p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=6db2b87291ad" width="1" height="1" alt="">&lt;hr&gt;&lt;p&gt;<a href="https://medium.com/blockwala/blockchain-migrator-from-scratch-to-explorer-6db2b87291ad" rel="external nofollow noopener" target="_blank">Blockchain Migrator — From scratch to explorer.</a> was originally published in <a href="https://medium.com/blockwala" rel="external nofollow noopener" target="_blank">Blockwala</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.&lt;/p&gt;</p> </body></html>